<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <link rel="stylesheet" type='text/css' href="/CSS/style.css">
    <link rel="stylesheet" type='text/css' href="/CSS/cart.css">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js" integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf" crossorigin="anonymous"></script>
    <script src="https://kit.fontawesome.com/920d6b8d66.js" crossorigin="anonymous"></script>
    <script src="/scripts/categoryHandler.js"></script>
    <title>DNG Mobile</title>
</head>
<body>
    <%- include('navbar.ejs') %> 

    <div class="container">
        <div class="no_item">
            <h3>Không có sản phẩm nào trong giỏ hàng</h3>
            <button onclick="window.location.href='/category';" type="button" class="btn btn-outline-danger">Mua hàng ngay</button>
        </div>
        <ul id="list_cart_item" class="list_cart_item">
            <!-- <li class="products_item">
                <div class="cart_item_image">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/3/3e/IPhone_12_Pro_Gold.svg/1200px-IPhone_12_Pro_Gold.svg.png" />
                </div>
                <div class="cart_item_price">
                    <p><span class="item_price">30.000.000</span> ₫</p>
                    <div class="cart_increase_quantity">
                        <div class="cart_minus">-</div>
                        <span key-value="abc" class="item_quantity">1</span>
                        <div class="cart_plus">+</div>
                    </div>
                </div>
                <div class="cart_item_content">
                    <h4>Tên điện thoại</h4>
                    <p>
                        abs
                    </p>
                    <button class="btn btn-danger btn_delete_item">Xóa</button>
                </div> -->
            </li>
        </ul>
    </div>
    <div class="container total_container">
        <div class="row cart_total_price">
            <div class="render_total">
                <span></span>
                <h4>Tổng tiền</h4>
            </div>
            <div class="render_price">
                <span class="total_item_price">0</span>
                ₫
            </div>
        </div>
        <% if(cookie){ %>
            <div class="payment_cart">
                <button class="btn btn-primary" onclick="PayCart()">Thanh toán khi nhận hàng</button>
                <h5 style="font-size: medium;text-align: left;margin: 1vw;">Thanh toán bằng ví điện tử</h5>
                <div class="paypal_button" id="paypal-button-container"></div>
            </div>
        <% }else{ %>
            <div class="payment_cart">
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#login-modal">Đăng nhập để thanh toán</button>
            </div>
        <% } %>

    </div>
    <script src="/scripts/CartHandle.js"></script>
    <script src="https://www.paypal.com/sdk/js?client-id=ASxD1QBtHp5HDaA9eCVEwPlMEtfA7ZISLeqwb_0BCo2_cCRN68SPu22g_yQC2z_IWChQlUtbvDBswKIZ&currency=USD"></script>
    <script>
        async function PayCartOnline(){
            var item = JSON.parse(localStorage.getItem(user));
            var arr_product = item.arr_product;
            let result = true;
            for(let index = 0; index < arr_product.length; index++) {
                let e = arr_product[index];
                await $.ajax({
                    method:'post',
                    url:'/handler/checkquantity',
                        data:{
                        p_id: e,
                        p_quantity: item.arr_quantity[index],
                    },
                success: (data) => {
                    if(data.mess == "failed"){
                        alert("Thanh toán không thành công");
                        result = false;                   
                    }
                    else if(data.mess == 'success'){
                                      
                    }
                    else{
                        var temp_arr = data.mess.split('-');
                        var temp = document.getElementsByClassName('cart_dt_name');
                        var notice = temp[index].innerHTML + " chỉ còn "+temp_arr[1]+" chiếc trong kho";
                        alert(notice);
                        result = false;
                        }
                    }
                });
                if(!result){
                    break;
                    }
                }

                if(result == true){
                    var total = 0;
                            for(var i = 0;i < item.arr_product.length;i++){
                                    p_id = item.arr_product[i];
                                    p_quantity = item.arr_quantity[i];
                                    await $.ajax({
                                        method : 'POST',
                                        url : '/handler/gettotal',
                                        data:{
                                            p_id : p_id,
                                            p_quantity : p_quantity,
                                        },
                                        success: (data)=>{
                                            if(data.mess == 'failed'){
                                                alert("Lỗi quá trong quá trình lưu đơn hàng");
                                            }
                                            else{
                                                total += Number(data.mess);
                                            }
                                        },
                                        error : (err)=>{
                                            console.log(err);
                                        }
                                    });
                                    
                            }
                            var save_stt = true;
                            var id_order = "";
                            for(let i = 0 ; i < item.arr_product.length ; i++){
                                if(i === 0){
                                    await $.ajax({
                                        method: 'POST',
                                        url : '/handler/saveorder',
                                        data:{
                                            id_product : item.arr_product[i],
                                            quantity :item.arr_quantity[i],
                                            payment_type : 1,
                                            total : total,
                                            index : i,
                                        },
                                        success: (data)=>{
                                            if(data.mess == 'failed'){
                                                save_stt = false;
                                            }
                                            else{
                                                id_order = data.id_order;
                                            }
                                        },
                                        error: (err)=>{
                                            console.log(err);
                                        }
                                    });
                                }
                                else{
                                    await $.ajax({
                                        method: 'POST',
                                        url : '/handler/saveorder',
                                        data:{
                                            id_product : item.arr_product[i],
                                            quantity :item.arr_quantity[i],
                                            payment_type : 0,
                                            total : total,
                                            index : i,
                                            id_order : id_order,
                                        },
                                        success: (data)=>{
                                            if(data.mess == 'failed'){
                                                save_stt = false;
                                            }
                                            else{
                                                
                                            }
                                        },
                                        error: (err)=>{
                                            console.log(err);
                                        }
                                    });
                                }
                                if(save_stt === false){
                                    var temp = document.getElementsByClassName('cart_dt_name');
                                    var notice = temp[i].innerHTML + " lỗi khi lưu đơn hàng";
                                    break;
                                }
                            }
                            if(save_stt === true){
                                alert('Lưu đơn hàng thành công');
                                var cart = new Cart([],[]);
                                localStorage.setItem(user,JSON.stringify(cart));
                                location.reload();
                            }
                        }
                    
                    }
        async function GetTotal(){
            var total = 0;
            var item = JSON.parse(localStorage.getItem(user));
            for(var i = 0;i < item.arr_product.length;i++){
                p_id = item.arr_product[i];
                p_quantity = item.arr_quantity[i];
                await $.ajax({
                    method : 'POST',
                    url : '/handler/gettotal',
                    data:{
                        p_id : p_id,
                        p_quantity : p_quantity,
                    },
                    success: (data)=>{
                        if(data.mess == 'failed'){
                            alert("Lỗi quá trong quá trình lưu đơn hàng");
                        }
                        else{
                            total += Number(data.mess);
                        }
                    },
                    error : (err)=>{
                        console.log(err);
                    }
                });             
            }
            total = Number(total) / 23000; 
            localStorage.setItem('totalPrice',JSON.stringify(total.toFixed(2)));
        }
        $('.paypal_button').hover(function(){
            GetTotal();
        },function(){});
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({
            // Set up the transaction
            createOrder: function(data, actions) {
                var totalprice = String(JSON.parse(localStorage.getItem('totalPrice')));
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: totalprice,
                        }
                    }]
                });
            },
            // Finalize the transaction
            onApprove: function(data, actions) {
                return actions.order.capture().then(function(details) {
                    // Show a success message to the buyer
                    // Save order
                    PayCartOnline();
                });
            }


        }).render('#paypal-button-container');
    </script>
    <!-- Load giỏ hàng -->
    <script>
        function GetCart(){
            var user = "<%- cookie %>";
            var item = JSON.parse(localStorage.getItem(user));
            if(item.arr_product.length > 0){
                $('.total_container').css('display','block');
                $('#list_cart_item').css('display','block');
                $('.no_item').css('display','none'); 
                item.arr_product.forEach(function(element,index){
                    $.ajax({
                        method:'post',
                        url:'/handler/load_cart',
                        data:{
                            data:element,
                        },
                        success: (data)=>{
                            // img
                            var img = document.createElement("IMG");
                            img.src = data.data.Hinh_M[0];
                            var divImg = document.createElement("DIV");
                            divImg.className = "cart_item_image";
                            divImg.appendChild(img);
                            // price
                            var span = document.createElement("SPAN");
                            span.className = "item_price";
                            span.innerHTML = DisplayPrice(data.data.Giaban_DT);
                            var p = document.createElement("P");
                            p.appendChild(span);
                            p.innerHTML = p.innerHTML + " ₫";

                            var divMinus = document.createElement("DIV");
                            divMinus.className = "cart_minus";
                            divMinus.innerHTML = "-";
                            divMinus.addEventListener('click',function(){
                                MinusItem(element);
                            });
                            var divPlus = document.createElement("DIV");
                            divPlus.className = "cart_plus";
                            divPlus.innerHTML = "+";
                            divPlus.addEventListener('click',function(){
                                PlusItem(element);
                            });
                            var spanQuan = document.createElement("SPAN");
                            spanQuan.className = "item_quantity";
                            spanQuan.setAttribute('key',element);
                            spanQuan.innerHTML = item.arr_quantity[index];
                            var divQuan = document.createElement("DIV");
                            divQuan.className = "cart_increase_quantity";
                            divQuan.appendChild(divMinus);
                            divQuan.appendChild(spanQuan);
                            divQuan.appendChild(divPlus);
                            var divPrice = document.createElement("DIV");
                            divPrice.className = "cart_item_price";
                            divPrice.appendChild(p);
                            divPrice.appendChild(divQuan);
                            // detail
                            var h4 = document.createElement("H4");
                            h4.className = "cart_dt_name";
                            h4.innerHTML = data.data.result.Ten_DT;
                            var pDetail = document.createElement("P");
                            pDetail.innerHTML = "Ram: "+data.data.result_ram.Ram+" GB ,Rom: "+data.data.result_rom.Rom+" GB, Màu : "+ data.data.result_color.Mau;
                            var button = document.createElement("BUTTON");
                            button.innerHTML = "Xóa";
                            button.className = "btn btn-danger btn_delete_item";
                            button.addEventListener('click',function(){
                                Delete(element);
                            });
                            var divContent = document.createElement("DIV");
                            divContent.className = "cart_item_content";
                            divContent.appendChild(h4);
                            divContent.appendChild(pDetail);
                            divContent.appendChild(button);
                            var li = document.createElement("LI");
                            li.className = "products_item";
                            li.appendChild(divImg);
                            li.appendChild(divPrice);
                            li.appendChild(divContent);
                            var ul = document.getElementById("list_cart_item");
                            ul.appendChild(li);
                            DisplayTotalPrice();
                        },
                        error : (err)=>{
                            console.log(err);
                        }
                    });
                });
            }
            else{
                $('.total_container').css('display','none');
                $('#list_cart_item').css('display','none');
                $('.no_item').css('display','block'); 
            }
        }
        GetCart();
    </script>
    <!-- Delete item -->
    <script>
        var user = '<%-cookie%>';
        var item = JSON.parse(localStorage.getItem(user));
        var cart = new Cart(item.arr_product,item.arr_quantity);
        function Delete(obj){
            cart.DeleteItem(obj);
            localStorage.setItem(user,JSON.stringify(cart));
            RemoveAllChild('list_cart_item');
            GetCart();
        }
    </script>
    <!--Plus and Minus item -->
    <script>
        var user = '<%- cookie %>';
        var item = JSON.parse(localStorage.getItem(user));
        var cart = new Cart(item.arr_product,item.arr_quantity);
        function MinusItem(obj){
            cart.AddNew(obj,-1);
            localStorage.setItem(user,JSON.stringify(cart));
            var index = cart.arr_product.indexOf(obj);
            var quantity = cart.arr_quantity[index];
            if(quantity < 1){
                Delete(obj);
            }
            else{
                $("[key="+obj+"]").html(quantity);
            }
            DisplayTotalPrice();
        }

        function PlusItem(obj){
            cart.AddNew(obj,1);
            localStorage.setItem(user,JSON.stringify(cart));
            var index = cart.arr_product.indexOf(obj);
            var quantity = cart.arr_quantity[index];
            $("[key="+obj+"]").html(quantity);
            DisplayTotalPrice();
        }
    </script>
    <!-- Thanh toán khi nhận hàng -->
    <script>
        var that = this;
        var user = "<%-cookie%>";

        async function PayCart(){
            var item = JSON.parse(localStorage.getItem(user));
            var arr_product = item.arr_product;
            let result = true;
            for(let index = 0; index < arr_product.length; index++) {
                let e = arr_product[index];
                await $.ajax({
                    method:'post',
                    url:'/handler/checkquantity',
                    data:{
                        p_id: e,
                        p_quantity: item.arr_quantity[index],
                    },
                    success: (data) => {
                        if(data.mess == "failed"){
                            alert("Thanh toán không thành công");
                            result = false;                   
                        }
                        else if(data.mess == 'success'){
                            
                        }
                        else{
                            var temp_arr = data.mess.split('-');
                            var temp = document.getElementsByClassName('cart_dt_name');
                            var notice = temp[index].innerHTML + " chỉ còn "+temp_arr[1]+" chiếc trong kho";
                            alert(notice);
                            result = false;
                        }
                    }
                });
                if(!result){
                    break;
                }
            }

            if(result == true){
                var total = 0;
                for(var i = 0;i < item.arr_product.length;i++){
                        p_id = item.arr_product[i];
                        p_quantity = item.arr_quantity[i];
                        await $.ajax({
                            method : 'POST',
                            url : '/handler/gettotal',
                            data:{
                                p_id : p_id,
                                p_quantity : p_quantity,
                            },
                            success: (data)=>{
                                if(data.mess == 'failed'){
                                    alert("Lỗi quá trong quá trình lưu đơn hàng");
                                }
                                else{
                                    total += Number(data.mess);
                                }
                            },
                            error : (err)=>{
                                console.log(err);
                            }
                        });
                        
                }
                var save_stt = true;
                var id_order = "";
                for(let i = 0 ; i < item.arr_product.length ; i++){
                    if(i === 0){
                        await $.ajax({
                            method: 'POST',
                            url : '/handler/saveorder',
                            data:{
                                id_product : item.arr_product[i],
                                quantity :item.arr_quantity[i],
                                payment_type : 0,
                                total : total,
                                index : i,
                            },
                            success: (data)=>{
                                if(data.mess == 'failed'){
                                    save_stt = false;
                                }
                                else{
                                    id_order = data.id_order;
                                }
                            },
                            error: (err)=>{
                                console.log(err);
                            }
                        });
                    }
                    else{
                        await $.ajax({
                            method: 'POST',
                            url : '/handler/saveorder',
                            data:{
                                id_product : item.arr_product[i],
                                quantity :item.arr_quantity[i],
                                payment_type : 0,
                                total : total,
                                index : i,
                                id_order : id_order,
                            },
                            success: (data)=>{
                                if(data.mess == 'failed'){
                                    save_stt = false;
                                }
                                else{
                                    
                                }
                            },
                            error: (err)=>{
                                console.log(err);
                            }
                        });
                    }
                    if(save_stt === false){
                        var temp = document.getElementsByClassName('cart_dt_name');
                        var notice = temp[i].innerHTML + " lỗi khi lưu đơn hàng";
                        break;
                    }
                }
                if(save_stt === true){
                    alert('Lưu đơn hàng thành công');
                    var cart = new Cart([],[]);
                    localStorage.setItem(user,JSON.stringify(cart));
                    location.reload();
                }
            }
           
        }
        
    </script>
</body>
</html>